<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Attendance Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <meta name="theme-color" content="#10b981"/>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      }
      /* Simple animation for the confirmation message */
      @keyframes fadeInDown {
        from {
          opacity: 0;
          transform: translate(-50%, -20px);
        }
        to {
          opacity: 1;
          transform: translate(-50%, 0);
        }
      }
      .animate-fade-in-down {
        animation: fadeInDown 0.3s ease-out forwards;
      }
    </style>
</head>
<body class="bg-gray-100 transition-colors duration-500 ease-in-out">

    <div class="min-h-screen flex items-start justify-center p-4 pt-8 sm:p-6">
        <div class="w-full max-w-3xl mx-auto bg-white p-5 sm:p-6 rounded-2xl shadow-lg transition-colors duration-500 ease-in-out">
            <header class="text-center mb-6">
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">Abo Qir Metro JV Orascom</h1>
                <p class="text-sm text-gray-500 mt-1">HR Department Attendance Tracker</p>
            </header>

            <main>
                <div class="bg-gray-50 p-4 rounded-lg flex flex-col sm:flex-row items-center justify-center gap-4 flex-wrap mb-4 border border-gray-200">
                    <div class="flex items-center gap-2">
                        <label for="movementSelect" class="text-sm font-medium text-gray-700 whitespace-nowrap">نوع الحركة:</label>
                        <select id="movementSelect" class="block w-40 px-3 py-2 bg-white border-2 border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 sm:text-sm transition-colors duration-300">
                            <option value="">اختر نوع الحركة</option>
                            <option value="دخول">دخول</option>
                            <option value="انصراف">انصراف</option>
                            <option value="انصراف مسائي">مسائي</option>
                        </select>
                    </div>
                    <div id="scanCount" class="font-bold text-emerald-800 bg-emerald-100 px-3 py-2 rounded-md">
                        عدد الحالات المسجلة: 0
                    </div>
                    <div class="flex gap-2">
                         <button id="startBtn" class="flex items-center justify-center gap-2 px-4 py-2 font-semibold text-white bg-emerald-500 rounded-md shadow-sm hover:bg-emerald-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><rect width="5" height="5" x="3" y="3" rx="1" /><rect width="5" height="5" x="16" y="3" rx="1" /><rect width="5" height="5" x="3" y="16" rx="1" /><path d="M21 16h-3a2 2 0 0 0-2 2v3" /><path d="M21 21v.01" /><path d="M12 7v3a2 2 0 0 1-2 2H7" /><path d="M3 12h.01" /><path d="M12 3h.01" /><path d="M12 16.01V12" /><path d="M16 12h.01" /><path d="M21 12h.01" /><path d="M12 21h.01" /></svg>
                            <span>Scan QR</span>
                        </button>
                        <button id="stopBtn" class="flex items-center justify-center gap-2 px-4 py-2 font-semibold text-white bg-red-500 rounded-md shadow-sm hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors">
                           <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><circle cx="12" cy="12" r="10" /><rect width="6" height="6" x="9" y="9" /></svg>
                            <span>Stop</span>
                        </button>
                         <button id="flashBtn" class="hidden items-center justify-center p-2.5 font-semibold text-white bg-gray-600 rounded-md shadow-sm hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors">
                            <svg id="flashIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                                <path id="flashOffPath" d="M13 2 3 14h9l-1 8 10-12h-9l1-8z"></path>
                                <path id="flashOnPath" d="M13 2 3 14h9l-1 8 10-12h-9l1-8z" fill="currentColor" style="display: none;"></path>
                            </svg>
                            <span class="sr-only">Toggle Flash</span>
                        </button>
                    </div>
                </div>
                
                <div id="reader" class="w-full max-w-md mx-auto rounded-lg overflow-hidden bg-black border-4 border-gray-300 transition-all duration-300"></div>

                <div class="manual-entry mt-6 pt-6 border-t">
                    <div class="flex flex-col sm:flex-row items-center justify-center gap-2">
                       <input id="manualInput" type="text" placeholder="إدخال يدوي - رقم أو اسم" class="w-full sm:w-64 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
                        <button id="manualAddBtn" class="w-full sm:w-auto flex items-center justify-center gap-2 px-4 py-2 font-semibold text-white bg-blue-500 rounded-md shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>
                            <span>إضافة يدوي</span>
                        </button>
                    </div>
                </div>

                <div class="export text-center mt-8">
                    <button id="exportBtn" class="inline-flex items-center justify-center gap-2 px-5 py-2.5 font-semibold text-white bg-cyan-500 rounded-md shadow-sm hover:bg-cyan-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-cyan-500 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                        <span>تصدير إلى Excel (CSV)</span>
                    </button>
                </div>
            </main>
        </div>
    </div>
    <div id="message" class="fixed top-5 left-1/2 -translate-x-1/2 px-6 py-3 rounded-lg shadow-xl text-white font-bold text-center z-50" style="display: none;"></div>

<script>
// --- Constants ---
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzGJy8WInLBIJGuqa90bDMWuK9SIHOJ4IH5No8EcvdPWJQsmUKfQqrPNe5aFB7pCwE-sA/exec';
const LOCAL_STORAGE_KEY = 'attendance_records_v3';
const DEBOUNCE_MS = 1500;
const READER_ID = "reader";
const BEEP_BASE64 = "UklGRuQAAABXQVZFZm10IBAAAAABAAEAgD4AAAB9AAACABAAZGF0YcQAAACAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA=";

// --- State ---
let records = [];
let html5QrCode = null;
let isScanning = false;
let isFlashOn = false;
let lastScannedId = null;
let lastScannedAt = 0;
const beepAudio = new Audio("data:audio/wav;base64," + BEEP_BASE64);
beepAudio.volume = 1.0;

// --- DOM Elements ---
const bodyEl = document.body;
const movementSelect = document.getElementById('movementSelect');
const scanCountEl = document.getElementById('scanCount');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const flashBtn = document.getElementById('flashBtn');
const readerEl = document.getElementById('reader');
const manualInput = document.getElementById('manualInput');
const manualAddBtn = document.getElementById('manualAddBtn');
const exportBtn = document.getElementById('exportBtn');
const messageEl = document.getElementById('message');

// --- THEME/COLOR Functions ---
function updateThemeColor() {
    const value = movementSelect.value;
    
    // Define color mappings
    const bodyColors = {
        '': 'bg-gray-100',
        'دخول': 'bg-emerald-50',
        'انصراف': 'bg-blue-50',
        'انصراف مسائي': 'bg-red-50'
    };
    const selectColors = {
        '': ['border-gray-300', 'focus:ring-emerald-500'],
        'دخول': ['border-emerald-500', 'focus:ring-emerald-500'],
        'انصراف': ['border-blue-500', 'focus:ring-blue-500'],
        'انصراف مسائي': ['border-red-500', 'focus:ring-red-500']
    };

    // Reset classes
    bodyEl.className = 'transition-colors duration-500 ease-in-out';
    bodyEl.classList.add(bodyColors[value] || bodyColors['']);
    
    movementSelect.classList.remove('border-gray-300', 'border-emerald-500', 'border-blue-500', 'border-red-500', 'focus:ring-emerald-500', 'focus:ring-blue-500', 'focus:ring-red-500');
    movementSelect.classList.add(...(selectColors[value] || selectColors['']));
}


// --- UI Functions ---
function updateUIState() {
    startBtn.disabled = isScanning;
    stopBtn.disabled = !isScanning;
    flashBtn.disabled = !isScanning;
    
    if (isScanning) {
        readerEl.style.minHeight = '250px';
        readerEl.classList.add('border-emerald-500');
        readerEl.classList.remove('border-gray-300');
    } else {
        readerEl.style.minHeight = '0px';
        readerEl.innerHTML = '';
        readerEl.classList.remove('border-emerald-500');
        readerEl.classList.add('border-gray-300');
        flashBtn.classList.add('hidden');
        isFlashOn = false;
        updateFlashUI();
    }
    scanCountEl.textContent = `عدد الحالات المسجلة: ${records.length}`;
}

function updateFlashUI() {
    const flashOnPath = document.getElementById('flashOnPath');
    const flashOffPath = document.getElementById('flashOffPath');
    
    if (isFlashOn) {
        flashBtn.classList.remove('bg-gray-600', 'hover:bg-gray-700');
        flashBtn.classList.add('bg-yellow-400', 'hover:bg-yellow-500', 'text-black');
        flashOnPath.style.display = 'block';
        flashOffPath.style.display = 'none';
    } else {
        flashBtn.classList.add('bg-gray-600', 'hover:bg-gray-700');
        flashBtn.classList.remove('bg-yellow-400', 'hover:bg-yellow-500', 'text-black');
        flashOnPath.style.display = 'none';
        flashOffPath.style.display = 'block';
    }
}

let messageTimer;
function showMessage(text, type = 'info') {
    clearTimeout(messageTimer);
    messageEl.textContent = text;
    messageEl.className = `fixed top-5 left-1/2 -translate-x-1/2 px-6 py-3 rounded-lg shadow-xl text-white font-bold text-center z-50 animate-fade-in-down`;
    if (type === 'success') messageEl.classList.add('bg-emerald-500');
    else if (type === 'error') messageEl.classList.add('bg-red-500');
    else messageEl.classList.add('bg-blue-500');
    
    messageEl.style.display = 'block';
    messageTimer = setTimeout(() => {
        messageEl.style.display = 'none';
    }, 2500);
}

// --- Core Functions ---
function playBeepAndVibrate() {
    beepAudio.currentTime = 0;
    beepAudio.play().catch(e => console.warn('Beep failed:', e));
    if (navigator.vibrate) {
        navigator.vibrate(180);
    }
}

function sendToGoogle(record) {
    const params = new URLSearchParams();
    params.append('records_batch', JSON.stringify([{
        id: record.id,
        employee_id: record.employeeId,
        movement_type: record.movement,
        timestamp: record.timestamp,
        source: record.source
    }]));
    const body = params.toString();

    fetch(GOOGLE_SCRIPT_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body
    }).catch(() => {
        if (navigator.sendBeacon) {
            navigator.sendBeacon(GOOGLE_SCRIPT_URL, new Blob([body], { type: 'application/x-www-form-urlencoded' }));
        }
    });
}

function addRecord(employeeId, source) {
    const movement = movementSelect.value;
    if (!movement) {
        showMessage('الرجاء اختيار نوع الحركة أولاً.', 'error');
        return false;
    }
    
    const now = new Date();
    const newRecord = {
        id: `local-${now.getTime()}-${Math.random().toString(36).slice(2, 8)}`,
        employeeId: String(employeeId).trim(),
        movement: movement,
        timestamp: now.toISOString(),
        date: now.toLocaleDateString('ar-EG'),
        time: now.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit', second: '2-digit' }),
        source: source,
    };

    records.unshift(newRecord);
    saveLocally();
    sendToGoogle(newRecord);
    playBeepAndVibrate();
    showMessage(`✅ تم تسجيل ${newRecord.movement} لـ ${newRecord.employeeId}`, 'success');
    updateUIState();
    return true;
}

// --- Scanner Logic ---
const onScanSuccess = (decodedText, decodedResult) => {
    const now = Date.now();
    if (decodedText === lastScannedId && (now - lastScannedAt) < DEBOUNCE_MS) {
        return; // Debounce
    }
    lastScannedId = decodedText;
    lastScannedAt = now;
    
    if (html5QrCode && isScanning) {
        html5QrCode.pause();
        addRecord(decodedText, 'QR');
        setTimeout(() => {
            if (isScanning) {
                 html5QrCode.resume();
            }
        }, 800);
    }
};

const onScanFailure = (error) => { /* ignore */ };

function startScanner() {
    if (!movementSelect.value) {
        showMessage('الرجاء اختيار نوع الحركة أولاً.', 'error');
        return;
    }
    if (isScanning) return;

    html5QrCode = new Html5Qrcode(READER_ID);
    const config = { fps: 10, qrbox: { width: 250, height: 250 }, aspectRatio: 1.0 };

    Html5Qrcode.getCameras().then(devices => {
        if (devices && devices.length) {
            const cameraId = devices.find(d => (d.label || '').toLowerCase().includes('back'))?.id || devices[0].id;
            html5QrCode.start(cameraId, config, onScanSuccess, onScanFailure)
                .then(() => {
                    isScanning = true;
                    updateUIState();
                    const track = html5QrCode.getRunningTrack();
                    const capabilities = track.getCapabilities();
                    if (capabilities.torch) {
                        flashBtn.classList.remove('hidden');
                    }
                })
                .catch(err => {
                    console.error("Failed to start scanner:", err);
                    showMessage('خطأ: لا يمكن الوصول للكاميرا. تأكد من الأذونات.', 'error');
                });
        } else {
            showMessage('خطأ: لم يتم العثور على كاميرا.', 'error');
        }
    }).catch(err => {
        console.error("Camera permissions error:", err);
        showMessage('خطأ: لا يمكن الوصول للكاميرا. تأكد من الأذونات.', 'error');
    });
}

function stopScanner() {
    if (html5QrCode && isScanning) {
        html5QrCode.stop()
            .then(() => {
                isScanning = false;
                html5QrCode = null;
                lastScannedId = null;
                showMessage('تم إيقاف الماسح.', 'info');
                updateUIState();
            })
            .catch(err => {
                console.error("Failed to stop scanner:", err);
                isScanning = false;
                updateUIState();
            });
    }
}

function toggleFlash() {
    if (isScanning && html5QrCode) {
        isFlashOn = !isFlashOn;
        html5QrCode.applyVideoConstraints({
            advanced: [{ torch: isFlashOn }]
        });
        updateFlashUI();
    }
}

// --- Event Handlers & Storage ---
function handleManualAdd() {
    const value = manualInput.value.trim();
    if (!value) {
        showMessage('أدخل رقم أو اسم صالح', 'error');
        return;
    }
    if (addRecord(value, 'Manual')) {
        manualInput.value = '';
    }
}

function exportToCsv() {
    if (records.length === 0) {
        showMessage('لا توجد سجلات لتصديرها.', 'info');
        return;
    }
    const data = [...records].sort((a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime());
    const headers = ['ID', 'Employee Code', 'Movement Type', 'Timestamp', 'Source'];
    
    const escapeCsv = (val) => {
        if (val == null) return '';
        let str = String(val);
        if (str.includes(',') || str.includes('"') || str.includes('\n')) {
            return `"${str.replace(/"/g, '""')}"`;
        }
        return str;
    };
    
    let csvContent = headers.join(',') + '\n';
    data.forEach(r => {
        const row = [
            escapeCsv(r.id),
            escapeCsv(r.employeeId),
            escapeCsv(r.movement),
            escapeCsv(new Date(r.timestamp).toLocaleString('en-CA', { hour12: false }).replace(',', '')),
            escapeCsv(r.source)
        ];
        csvContent += row.join(',') + '\n';
    });

    const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `Attendance_Records_${new Date().toISOString().slice(0, 10)}.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function saveLocally() {
    try {
        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(records));
    } catch (e) {
        console.error("Failed to save to local storage", e);
    }
}

function loadLocally() {
    try {
        const stored = localStorage.getItem(LOCAL_STORAGE_KEY);
        if (stored) {
            records = JSON.parse(stored);
        }
    } catch (e) {
        console.error("Failed to load from local storage", e);
        records = [];
    }
    updateUIState();
}

// --- Initialization ---
document.addEventListener('DOMContentLoaded', () => {
    startBtn.addEventListener('click', startScanner);
    stopBtn.addEventListener('click', stopScanner);
    flashBtn.addEventListener('click', toggleFlash);
    manualAddBtn.addEventListener('click', handleManualAdd);
    exportBtn.addEventListener('click', exportToCsv);
    movementSelect.addEventListener('change', updateThemeColor);
    
    loadLocally();
    updateThemeColor(); // Set initial theme
});

</script>

</body>
</html>
