<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Attendance Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <meta name="theme-color" content="#10b981"/>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      }
      /* Simple animation for the confirmation message */
      @keyframes fadeInDown {
        from {
          opacity: 0;
          transform: translate(-50%, -20px);
        }
        to {
          opacity: 1;
          transform: translate(-50%, 0);
        }
      }
      .animate-fade-in-down {
        animation: fadeInDown 0.3s ease-out forwards;
      }
      /* Hide number input arrows */
      input[type=number]::-webkit-inner-spin-button,
      input[type=number]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      input[type=number] {
        -moz-appearance: textfield;
      }
      /* Animation for active flash button */
      @keyframes pulse-yellow {
        0%, 100% {
          transform: scale(1);
          box-shadow: 0 0 0 0 rgba(250, 204, 21, 0.7);
        }
        50% {
          transform: scale(1.05);
          box-shadow: 0 0 0 7px rgba(250, 204, 21, 0);
        }
      }
      .animate-pulse-yellow {
        animation: pulse-yellow 1.5s infinite;
      }
    </style>
</head>
<body class="bg-gray-100 transition-colors duration-500 ease-in-out">

    <div class="min-h-screen flex items-start justify-center p-4 pt-8 sm:p-6">
        <div class="w-full max-w-3xl mx-auto bg-white p-5 sm:p-6 rounded-2xl shadow-lg transition-colors duration-500 ease-in-out">
            <header class="text-center mb-6">
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">Abo Qir Metro JV Orascom</h1>
                <p class="text-sm text-gray-500 mt-1">HR Department Attendance Tracker</p>
            </header>

            <main>
                <div class="bg-gray-50 p-4 rounded-lg flex flex-col sm:flex-row items-center justify-center gap-4 flex-wrap mb-4 border border-gray-200">
                    <div class="flex items-center gap-2">
                        <label for="movementSelect" class="text-sm font-medium text-gray-700 whitespace-nowrap">نوع الحركة:</label>
                        <select id="movementSelect" class="block w-40 px-3 py-2 border-2 rounded-md shadow-sm focus:outline-none focus:ring-2 sm:text-sm transition-all duration-300">
                            <option value="">اختر نوع الحركة</option>
                            <option value="دخول">دخول</option>
                            <option value="انصراف">انصراف</option>
                            <option value="انصراف مسائي">مسائي</option>
                        </select>
                    </div>
                    <div id="scanCount" class="font-bold text-emerald-800 bg-emerald-100 px-3 py-2 rounded-md">
                        عدد الحالات المسجلة: 0
                    </div>
                    <div class="flex gap-2">
                         <button id="startBtn" class="flex items-center justify-center gap-2 px-4 py-2 font-semibold text-white bg-emerald-500 rounded-md shadow-sm hover:bg-emerald-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><rect width="5" height="5" x="3" y="3" rx="1" /><rect width="5" height="5" x="16" y="3" rx="1" /><rect width="5" height="5" x="3" y="16" rx="1" /><path d="M21 16h-3a2 2 0 0 0-2 2v3" /><path d="M21 21v.01" /><path d="M12 7v3a2 2 0 0 1-2 2H7" /><path d="M3 12h.01" /><path d="M12 3h.01" /><path d="M12 16.01V12" /><path d="M16 12h.01" /><path d="M21 12h.01" /><path d="M12 21h.01" /></svg>
                            <span>Scan QR</span>
                        </button>
                        <button id="stopBtn" class="flex items-center justify-center gap-2 px-4 py-2 font-semibold text-white bg-red-500 rounded-md shadow-sm hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors">
                           <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><circle cx="12" cy="12" r="10" /><rect width="6" height="6" x="9" y="9" /></svg>
                            <span>Stop</span>
                        </button>
                         <button id="flashBtn" class="flex items-center justify-center p-2.5 font-semibold text-white bg-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-offset-2 transition-all duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                                <path id="flashPath" d="M13 2 3 14h9l-1 8 10-12h-9l1-8z"></path>
                            </svg>
                            <span class="sr-only">Toggle Flash</span>
                        </button>
                        <button id="volumeBtn" class="flex items-center justify-center p-2.5 font-semibold text-white bg-gray-600 rounded-md shadow-sm hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                                <polygon id="volumeOnPath" points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path id="volumeOffPath" d="M11 5 6 9H2v6h4l5 4V5zM23 9l-6 6M17 9l6 6" style="display: none;"></path>
                            </svg>
                            <span class="sr-only">Toggle Sound</span>
                        </button>
                    </div>
                </div>
                
                <div id="reader" class="w-full max-w-md mx-auto rounded-lg overflow-hidden bg-black border-4 border-gray-300 transition-all duration-300"></div>

                <div class="manual-entry mt-6 pt-6 border-t">
                    <div class="flex flex-col sm:flex-row items-center justify-center gap-2">
                       <input id="manualInput" type="text" inputmode="numeric" pattern="[0-9]*" maxlength="14" placeholder="إدخال يدوي - 14 رقم بحد أقصى" class="w-full sm:w-64 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
                        <button id="manualAddBtn" class="w-full sm:w-auto flex items-center justify-center gap-2 px-4 py-2 font-semibold text-white bg-blue-500 rounded-md shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>
                            <span>إضافة يدوي</span>
                        </button>
                    </div>
                </div>

                <div class="export text-center mt-8">
                    <button id="exportBtn" class="inline-flex items-center justify-center gap-2 px-5 py-2.5 font-semibold text-white bg-cyan-500 rounded-md shadow-sm hover:bg-cyan-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-cyan-500 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                        <span>تصدير إلى Excel (CSV)</span>
                    </button>
                </div>
            </main>
        </div>
    </div>
    <div id="message" class="fixed top-5 left-1/2 -translate-x-1/2 px-6 py-3 rounded-lg shadow-xl text-white font-bold text-center z-50" style="display: none;"></div>

<script>
// --- Constants ---
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzGJy8WInLBIJGuqa90bDMWuK9SIHOJ4IH5No8EcvdPWJQsmUKfQqrPNe5aFB7pCwE-sA/exec';
const SESSION_STORAGE_KEY = 'attendance_records_session_v1';
const VOLUME_STORAGE_KEY = 'attendance_app_isMuted';
const DEBOUNCE_MS = 1500;
const READER_ID = "reader";
// A new, clearer, and more reliable digital beep sound
const BEEP_BASE64 = 'UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YV8vT19AAAAA//8CAP//AgD//gIA//4CAP//BQD//wUA//8HAP//BwD//wMA//8CAP//AwD//wEAAAAA';

// --- State ---
let records = [];
let html5QrCode = null;
let isScanning = false;
let isFlashOn = false;
let canUseFlash = false;
let isMuted = false;
let lastScannedId = null;
let lastScannedAt = 0;
let beepSound = null;
let audioUnlocked = false;

// --- DOM Elements ---
const movementSelect = document.getElementById('movementSelect');
const scanCountEl = document.getElementById('scanCount');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const flashBtn = document.getElementById('flashBtn');
const flashPath = document.getElementById('flashPath');
const volumeBtn = document.getElementById('volumeBtn');
const volumeOnPath = document.getElementById('volumeOnPath');
const volumeOffPath = document.getElementById('volumeOffPath');
const readerEl = document.getElementById('reader');
const manualInput = document.getElementById('manualInput');
const manualAddBtn = document.getElementById('manualAddBtn');
const exportBtn = document.getElementById('exportBtn');
const messageEl = document.getElementById('message');

// --- THEME/COLOR Functions ---
function updateThemeColor() {
    const value = movementSelect.value;
    
    const bodyColorClasses = {
        '': 'bg-gray-100',
        'دخول': 'bg-emerald-50',
        'انصراف': 'bg-blue-50',
        'انصراف مسائي': 'bg-red-50'
    };

    const selectColorClasses = {
         '': ['bg-white', 'text-gray-800', 'border-gray-400', 'focus:ring-emerald-500'],
        'دخول': ['bg-emerald-500', 'text-white', 'font-semibold', 'border-emerald-600', 'focus:ring-emerald-400'],
        'انصراف': ['bg-blue-500', 'text-white', 'font-semibold', 'border-blue-600', 'focus:ring-blue-400'],
        'انصراف مسائي': ['bg-red-500', 'text-white', 'font-semibold', 'border-red-600', 'focus:ring-red-400']
    };
    
    document.body.className = `transition-colors duration-500 ease-in-out ${bodyColorClasses[value] || 'bg-gray-100'}`;

    const allSelectClasses = Object.values(selectColorClasses).flat();
    movementSelect.classList.remove(...new Set(allSelectClasses));
    movementSelect.classList.add(...(selectColorClasses[value] || selectColorClasses['']));
}


// --- UI Functions ---
function updateUIState() {
    startBtn.disabled = isScanning;
    stopBtn.disabled = !isScanning;
    flashBtn.disabled = !isScanning || !canUseFlash;

    if (isScanning) {
        readerEl.style.minHeight = '250px';
        readerEl.classList.add('border-emerald-500');
        readerEl.classList.remove('border-gray-300');
    } else {
        readerEl.style.minHeight = '0px';
        readerEl.innerHTML = '';
        readerEl.classList.remove('border-emerald-500');
        readerEl.classList.add('border-gray-300');
        isFlashOn = false;
        canUseFlash = false;
        updateFlashUI();
        // Keep flash button disabled state consistent after stopping
        flashBtn.disabled = true;
    }
    scanCountEl.textContent = `عدد الحالات المسجلة: ${records.length}`;
}

function updateFlashUI() {
    const activeClasses = ['bg-yellow-400', 'hover:bg-yellow-500', 'text-black', 'ring-2', 'ring-yellow-300', 'ring-offset-1'];
    const inactiveClasses = ['bg-gray-600', 'hover:bg-gray-700', 'text-white'];
    
    if (isFlashOn) {
        flashBtn.classList.remove(...inactiveClasses);
        flashBtn.classList.add(...activeClasses);
        flashBtn.classList.add('animate-pulse-yellow');
        flashPath.setAttribute('fill', 'currentColor');
    } else {
        flashBtn.classList.remove(...activeClasses);
        flashBtn.classList.add(...inactiveClasses);
        flashBtn.classList.remove('animate-pulse-yellow');
        flashPath.setAttribute('fill', 'none');
    }
}

function updateVolumeUI() {
    if (isMuted) {
        volumeBtn.classList.remove('bg-gray-600', 'hover:bg-gray-700');
        volumeBtn.classList.add('bg-red-500', 'hover:bg-red-600');
        volumeOnPath.style.display = 'none';
        volumeOffPath.style.display = 'block';
    } else {
        volumeBtn.classList.add('bg-gray-600', 'hover:bg-gray-700');
        volumeBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
        volumeOnPath.style.display = 'block';
        volumeOffPath.style.display = 'none';
    }
}

let messageTimer;
function showMessage(text, type = 'info') {
    clearTimeout(messageTimer);
    messageEl.textContent = text;
    messageEl.className = `fixed top-5 left-1/2 -translate-x-1/2 px-6 py-3 rounded-lg shadow-xl text-white font-bold text-center z-50 animate-fade-in-down`;
    if (type === 'success') messageEl.classList.add('bg-emerald-500');
    else if (type === 'error') messageEl.classList.add('bg-red-500');
    else messageEl.classList.add('bg-blue-500');
    
    messageEl.style.display = 'block';
    messageTimer = setTimeout(() => {
        messageEl.style.display = 'none';
    }, 2500);
}

// --- Core Functions ---
function unlockAudio() {
    if (audioUnlocked || !beepSound) return;
    beepSound.play()
        .then(() => {
            beepSound.pause();
            beepSound.currentTime = 0;
            audioUnlocked = true;
            console.log("Audio unlocked successfully.");
        })
        .catch(e => {
            console.warn("Audio unlock failed. Sound may not play on scan.", e);
        });
}

function playBeepAndVibrate() {
    if (!isMuted && beepSound) {
        beepSound.currentTime = 0;
        beepSound.play().catch(e => console.warn('Audio playback failed:', e));
    }
    if (navigator.vibrate) {
        navigator.vibrate(180);
    }
}

function sendToGoogle(record) {
    const params = new URLSearchParams();
    params.append('records_batch', JSON.stringify([{
        id: record.id,
        employee_id: record.employeeId,
        movement_type: record.movement,
        timestamp: record.timestamp,
        source: record.source
    }]));
    const body = params.toString();

    fetch(GOOGLE_SCRIPT_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body
    }).catch(() => {
        if (navigator.sendBeacon) {
            navigator.sendBeacon(GOOGLE_SCRIPT_URL, new Blob([body], { type: 'application/x-www-form-urlencoded' }));
        }
    });
}

function addRecord(employeeId, source) {
    const movement = movementSelect.value;
    if (!movement) {
        showMessage('الرجاء اختيار نوع الحركة أولاً.', 'error');
        return false;
    }
    
    const now = new Date();
    const newRecord = {
        id: `local-${now.getTime()}-${Math.random().toString(36).slice(2, 8)}`,
        employeeId: String(employeeId).trim(),
        movement: movement,
        timestamp: now.toISOString(),
        date: now.toLocaleDateString('ar-EG'),
        time: now.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit', second: '2-digit' }),
        source: source,
    };

    records.unshift(newRecord);
    saveToSession();
    sendToGoogle(newRecord);
    playBeepAndVibrate();
    showMessage(`✅ تم تسجيل ${newRecord.movement} لـ ${newRecord.employeeId}`, 'success');
    updateUIState();
    return true;
}

// --- Scanner Logic ---
const onScanSuccess = (decodedText, decodedResult) => {
    const now = Date.now();
    if (decodedText === lastScannedId && (now - lastScannedAt) < DEBOUNCE_MS) {
        return; // Debounce
    }
    lastScannedId = decodedText;
    lastScannedAt = now;
    
    if (html5QrCode && isScanning) {
        html5QrCode.pause();
        addRecord(decodedText, 'QR');
        setTimeout(() => {
            if (isScanning) {
                 html5QrCode.resume().then(() => {
                     // **FIX**: If flash was on, re-apply it after resuming the camera stream.
                     if (isFlashOn) {
                         // Use a short timeout to give the stream a moment to stabilize
                         setTimeout(() => setFlash(true), 100); 
                     }
                 }).catch(err => console.error("Failed to resume scanner:", err));
            }
        }, 800);
    }
};

function startScanner() {
    unlockAudio(); // Attempt to unlock audio context on user gesture.

    if (!movementSelect.value) {
        showMessage('الرجاء اختيار نوع الحركة أولاً.', 'error');
        return;
    }
    if (isScanning) return;

    html5QrCode = new Html5Qrcode(READER_ID);
    const config = { fps: 10, qrbox: { width: 250, height: 250 }, aspectRatio: 1.0 };

    Html5Qrcode.getCameras().then(devices => {
        if (devices && devices.length) {
            const cameraId = devices.find(d => (d.label || '').toLowerCase().includes('back'))?.id || devices[0].id;
            html5QrCode.start(cameraId, config, onScanSuccess, (err) => {/* ignore */})
                .then(() => {
                    isScanning = true;
                    try {
                        const track = html5QrCode.getRunningTrack();
                        if (track) {
                            const capabilities = track.getCapabilities();
                             // Robustly check if the torch capability is supported.
                            if (capabilities && typeof capabilities.torch === 'boolean') {
                                canUseFlash = true;
                            } else {
                                canUseFlash = false;
                            }
                        }
                    } catch (e) {
                        console.warn("Could not check for torch capabilities:", e);
                        canUseFlash = false;
                    }
                    updateUIState();
                })
                .catch(err => {
                    console.error("Failed to start scanner:", err);
                    showMessage('خطأ: لا يمكن الوصول للكاميرا. تأكد من الأذونات.', 'error');
                    html5QrCode = null;
                });
        } else {
            showMessage('خطأ: لم يتم العثور على كاميرا.', 'error');
            html5QrCode = null;
        }
    }).catch(err => {
        console.error("Camera permissions error:", err);
        showMessage('خطأ: لا يمكن الوصول للكاميرا. تأكد من الأذونات.', 'error');
        html5QrCode = null;
    });
}

function stopScanner() {
    if (html5QrCode && isScanning) {
        html5QrCode.stop()
            .then(() => {
                showMessage('تم إيقاف الماسح.', 'info');
            })
            .catch(err => {
                console.error("Failed to stop scanner cleanly:", err);
            })
            .finally(() => {
                isScanning = false;
                html5QrCode = null;
                lastScannedId = null;
                updateUIState();
            });
    }
}

// **FIX**: Centralized and robust function to control the flash
async function setFlash(newState) {
    if (!isScanning || !html5QrCode || !canUseFlash) {
        return;
    }

    try {
        const track = html5QrCode.getRunningTrack();
        if (!track) {
            console.error("No running video track to apply flash.");
            return;
        }
        await track.applyConstraints({
            advanced: [{ torch: newState }]
        });
        isFlashOn = newState;
        updateFlashUI();
    } catch (err) {
        console.error("Failed to set flash state:", err);
        showMessage('فشل التحكم بالفلاش. قد لا يكون مدعومًا.', 'error');
        canUseFlash = false; // Disable if it fails to prevent repeated errors
        updateUIState();
    }
}

// **FIX**: Simplified toggle function
async function toggleFlash() {
    await setFlash(!isFlashOn);
}

function toggleMute() {
    isMuted = !isMuted;
    localStorage.setItem(VOLUME_STORAGE_KEY, isMuted);
    updateVolumeUI();
}

// --- Event Handlers & Storage ---
function handleManualAdd() {
    const value = manualInput.value.trim();
    if (!value) {
        showMessage('أدخل رقمًا صالحًا', 'error');
        return;
    }
    if (addRecord(value, 'Manual')) {
        manualInput.value = '';
    }
}

function exportToCsv() {
    if (records.length === 0) {
        showMessage('لا توجد سجلات لتصديرها.', 'info');
        return;
    }
    const data = [...records].sort((a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime());
    const headers = ['ID', 'Employee Code', 'Movement Type', 'Timestamp', 'Source'];
    
    const escapeCsv = (val) => {
        if (val == null) return '';
        let str = String(val);
        if (str.includes(',') || str.includes('"') || str.includes('\n')) {
            return `"${str.replace(/"/g, '""')}"`;
        }
        return str;
    };
    
    let csvContent = headers.join(',') + '\n';
    data.forEach(r => {
        const row = [
            escapeCsv(r.id),
            escapeCsv(r.employeeId),
            escapeCsv(r.movement),
            escapeCsv(new Date(r.timestamp).toLocaleString('en-CA', { hour12: false }).replace(',', '')),
            escapeCsv(r.source)
        ];
        csvContent += row.join(',') + '\n';
    });

    const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `Attendance_Records_${new Date().toISOString().slice(0, 10)}.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function saveToSession() {
    try {
        sessionStorage.setItem(SESSION_STORAGE_KEY, JSON.stringify(records));
    } catch (e) {
        console.error("Failed to save to session storage", e);
    }
}

function loadFromSession() {
    try {
        const stored = sessionStorage.getItem(SESSION_STORAGE_KEY);
        if (stored) {
            records = JSON.parse(stored);
        }
    } catch (e) {
        console.error("Failed to load from session storage", e);
        records = [];
    }
}

function loadVolumePreference() {
    try {
        const stored = localStorage.getItem(VOLUME_STORAGE_KEY);
        isMuted = stored === 'true';
    } catch (e) {
        console.error("Failed to load volume preference from local storage", e);
        isMuted = false;
    }
}

// --- Initialization ---
document.addEventListener('DOMContentLoaded', () => {
    // Initialize the single, reusable audio object
    try {
        beepSound = new Audio("data:audio/wav;base64," + BEEP_BASE64);
        beepSound.volume = 1.0;
    } catch (e) {
        console.error("Failed to initialize audio object:", e);
    }

    startBtn.addEventListener('click', startScanner);
    stopBtn.addEventListener('click', stopScanner);
    flashBtn.addEventListener('click', toggleFlash);
    volumeBtn.addEventListener('click', toggleMute);
    manualAddBtn.addEventListener('click', handleManualAdd);
    exportBtn.addEventListener('click', exportToCsv);
    movementSelect.addEventListener('change', updateThemeColor);

    manualInput.addEventListener('input', () => {
        manualInput.value = manualInput.value.replace(/[^0-9]/g, '');
    });
    
    loadFromSession();
    loadVolumePreference();
    updateUIState();
    updateThemeColor();
    updateVolumeUI();
});

</script>

</body>
</html>
